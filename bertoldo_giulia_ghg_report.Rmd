---
title: "Global Greenhouse Gas (GHG) Emissions Report"
author: "Giulia Bertoldo"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
# Set up and variables 
knitr::opts_chunk$set(echo = TRUE)
path = 'data/EDGAR_2024_GHG_booklet_2024.xlsx'
# Load packages
library(tidyverse)
library(readxl)
library(purrr)
library(stringr)
library(RColorBrewer)
```

# Introduction 
The report uses greenhouse gas (GHG) emissions time series data from the Emissions Database for Global Atmospheric Research (EDGAR). The database provides data covering all countries and spanning from 1970 to 2023. The report includes three charts providing insights to the questions:

1. What is the evolution of GHG growth in the euro area, in the European Union, and worldwide?

2. How do countries (classified as in the World Bank income groups) compare with respect to GHG emissions per capita?

3. What is the contribution of individual countries and continents to the worldwide GHG emissions?

# Process
Data have been cleaned, analyzed, and visualized using R, mainly through the tidyverse package (e.g., dplyr, ggplot). The report has been generated using RMarkdown. The workflow included working with RStudio, git and GitHub. 

# Evolution of GHG emission growth

What is the evolution of GHG growth in the euro area, in the European Union, and worldwide?

```{r include=FALSE}
# Read data
df_ghg_totals_by_country <- read_excel(path, sheet = 'GHG_totals_by_country')

# DATA QUALITY -------------------------------------------------------------------------------
#### Data types checks ####
glimpse(df_ghg_totals_by_country)

# `EDGAR Country Code`
df_ghg_totals_by_country$`EDGAR Country Code`
df_ghg_totals_by_country$Country

#### Upper case country name ####
df_ghg_totals_by_country <- df_ghg_totals_by_country %>%
  mutate (Country = str_to_upper(Country))

####  Missing values ####
as.data.frame(map(df_ghg_totals_by_country, ~sum(is.na(.))))

df_na <- df_ghg_totals_by_country %>%
  filter(if_any(everything(), is.na))

# Filter out two rows with missing values
df_ghg_totals_by_country <- df_ghg_totals_by_country %>%
  filter(if_all(everything(), ~ !is.na(.)))

####  Duplicates ####
duplicate_rows <- df_ghg_totals_by_country %>%
  duplicated(.) | duplicated(df_ghg_totals_by_country, fromLast = TRUE)
sum(duplicate_rows)

#### Factors####
# Convert character columns to factor
df_ghg_totals_by_country <- df_ghg_totals_by_country %>%
  mutate(across(where(is.character), factor))

#### EUROZONE FLAG, EU27 FLAG, GLOBAL FLAG ####
# eurozone
eurozone <- c('AUSTRIA', 'BELGIUM', 'CROATIA', 'CYPRUS', 'ESTONIA', 'FINLAND',
              'FRANCE AND MONACO', 'GERMANY', 'GREECE', 'IRELAND',
              'ITALY, SAN MARINO AND THE HOLY SEE', 'LATVIA', 'LITHUANIA',
              'LUXEMBOURG', 'MALTA', 'NETHERLANDS', 'PORTUGAL', 'SLOVAKIA',
              'SLOVENIA', 'SPAIN AND ANDORRA')

# Keep only relevant rows
df_ghg_totals_by_country <- df_ghg_totals_by_country %>%
  filter((Country %in% c('EU27', 'GLOBAL TOTAL')) | (Country %in% eurozone))

df_ghg_totals_by_country <- df_ghg_totals_by_country %>%
  mutate(GEO_TYPE = case_when(
    Country == 'EU27' ~ 'EU27',
    Country == 'GLOBAL TOTAL' ~ 'GLOBAL',
    Country %in% eurozone ~ 'EUROZONE'
  ))

check_eurozone <- df_ghg_totals_by_country %>%
  select(Country, GEO_TYPE)
print(check_eurozone, n = Inf )

#### Pivot longer ####
df_ghg_totals_by_country_long <- df_ghg_totals_by_country %>%
  pivot_longer(cols = `1970`: `2023`, names_to = 'YEAR', values_to = 'GHG_EMM')

glimpse(df_ghg_totals_by_country_long)

#### Select column ####
df_ghg_totals_by_country_long <- df_ghg_totals_by_country_long %>%
  select(GEO_TYPE, YEAR, GHG_EMM)

#### Aggregate ####
df_ghg_totals_by_country_group <- df_ghg_totals_by_country_long %>%
  group_by(GEO_TYPE, YEAR) %>%
  summarize(TOT_GHG_EMM = sum(GHG_EMM), .groups = "drop")
glimpse(df_ghg_totals_by_country_group)

#### Geography Type as factor
df_ghg_totals_by_country_group$GEO_TYPE <- factor(df_ghg_totals_by_country_group$GEO_TYPE,
                                                  levels = c('GLOBAL',
                                                             'EU27',
                                                             'EUROZONE'),
                                                  labels = c("Worldwide",
                                                             "European Union",
                                                             "Eurozone")
)


```

```{r echo = FALSE}
#### CHART 1 --------------------------------------------------
pl3 <- brewer.pal(11, 'PRGn')
custom_colors <- c("#40004B", "#1B7837", "#A6DBA0")


ggplot(df_ghg_totals_by_country_group, aes(x = YEAR, y = TOT_GHG_EMM, color = factor(GEO_TYPE), group = GEO_TYPE)) +
  geom_line() +
  labs(
    title = 'Evolution of GHG Emissions',
    x = 'Year',
    y = 'GHG (Mt CO2eq/yr)',
    color = 'Geography'
  ) +
  scale_color_manual(values = custom_colors) +
  theme_light() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 10),
    legend.key.size = unit(0.3, "cm"),
    legend.spacing.y = unit(0.2, "cm")
) +
  scale_x_discrete(breaks = df_ghg_totals_by_country_group$YEAR[seq(1, length(df_ghg_totals_by_country_group$YEAR), by = 2)])

```

# Contries GHG emission comparison

How do countries (classified as in the World Bank income groups) compare with respect to GHG emissions per capita?

```{r include=FALSE}
# Read data
path = 'data/EDGAR_2024_GHG_booklet_2024.xlsx'
df_per_capita_by_country <- read_excel(path, sheet = 'GHG_per_capita_by_country')
df_class <- read_excel('data/CLASS.xlsx')
# DATA QUALITY -------------------------------------------------------------------------------
#### Data types checks ####
glimpse(df_per_capita_by_country)
glimpse(df_class)

#### Upper case country name ####
df_per_capita_by_country <- df_per_capita_by_country %>%
  mutate (Country = str_to_upper(Country))
df_per_capita_by_country$Country

df_class <- df_class %>%
  mutate (Economy = str_to_upper(Economy))
df_class$Economy

####  Missing values ####
# GHG data
as.data.frame(map(df_per_capita_by_country, ~sum(is.na(.))))
df_na <- df_per_capita_by_country %>%
  filter(if_any(everything(), is.na))
# Filter out two rows with missing values
df_per_capita_by_country <- df_per_capita_by_country %>%
  filter(if_all(everything(), ~ !is.na(.)))

# Income data
as.data.frame(map(df_class, ~sum(is.na(.))))
df_na_ingro <- df_class %>%
  filter(is.na(Economy) == TRUE)
df_na_ingro
# Filter out row with missing values
df_class <- df_class %>%
  filter(is.na(Economy) != TRUE)
# Venezuela is not classified into an income group + other regional areas
null_income <- df_class %>%
  filter(is.na(`Income group`) == TRUE)
print(null_income, n = Inf)

####  Duplicates ####
duplicate_rows <- df_per_capita_by_country %>%
  duplicated(.) | duplicated(df_per_capita_by_country, fromLast = TRUE)
sum(duplicate_rows)

#### Factors ####
# Convert character columns to factor
df_per_capita_by_country <- df_per_capita_by_country %>%
  mutate(across(where(is.character), factor))

#### Left Outer join ####
df_per_capita_by_country_with_income <- left_join(df_per_capita_by_country,
                                                  df_class %>%
                                                    select(Code,`Income group`),
                                                  by = c('EDGAR Country Code' = 'Code'))

# Check join results
glimpse(df_per_capita_by_country_with_income)

# Apart from Venezuela, EU27, GLOBAL, other 12 countries have not been assigned an income group
df_per_capita_by_country_with_income %>%
  filter(is.na(`Income group`)) %>%
  select(`EDGAR Country Code`, 'Country', `Income group` )

# Drop rows without income group
df_per_capita_by_country_with_income <- df_per_capita_by_country_with_income %>%
  filter(is.na(`Income group`) == FALSE)

#### Pivot longer ####
df_per_capita_by_income_long <- df_per_capita_by_country_with_income %>%
  pivot_longer(cols = `1970`: `2023`, names_to = 'YEAR', values_to = 'GHG_EMM')

glimpse(df_per_capita_by_income_long)

#### Aggregate ####
df_per_capita_by_income_long_gr <- df_per_capita_by_income_long %>%
  group_by(`Income group`, YEAR) %>%
  summarize(TOT_GHG_EMM = sum(GHG_EMM), .groups = "drop")
df_per_capita_by_income_long_gr

#### Income groups as factos ####
df_per_capita_by_income_long_gr$`Income group` <- factor(df_per_capita_by_income_long_gr$`Income group`,
                                                         levels = c("High income",
                                                                    "Upper middle income",
                                                                    "Lower middle income",
                                                                    "Low income")
)

glimpse(df_per_capita_by_income_long_gr)
```


```{r echo = FALSE}
#### CHART 2 --------------------------------------------------
## Choose colors
pl3 <- brewer.pal(11, 'PRGn')
custom_color <- c("#D9F0D3", "#A6DBA0", "#5AAE61", "#1B7837")

## Stacked bar chart
ggplot(df_per_capita_by_income_long_gr, aes(x = YEAR,
                                            y = TOT_GHG_EMM,
                                            fill = factor(`Income group`),
                                            group = `Income group`)) +
  geom_bar(stat = 'identity', position = 'stack',color = "white", linewidth = 0.5) +
  scale_fill_manual(values = c("High income" =  "#1B7837",
                               "Upper middle income" = "#5AAE61",
                               "Lower middle income" = "#A6DBA0",
                               "Low income" ="#D9F0D3")) +
  labs(
    title = 'Country (Income Group) Contribution to GHG Emissions',
    x = 'Year',
    y = 'GHG (t CO2eq/cap/yr)',
    fill = 'Income Group'
  ) +
  theme_light() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    legend.text = element_text(size = 8),          # Smaller text for legend items
    legend.title = element_text(size = 10),       # Smaller text for legend title
    legend.key.size = unit(0.3, "cm"),            # Reduce legend key size
    legend.spacing.y = unit(0.2, "cm")           # Adjust vertical spacing between items
  ) +
  scale_x_discrete(breaks = df_per_capita_by_income_long_gr$YEAR[seq(1, length(df_per_capita_by_income_long_gr$YEAR), by = 2)])

```


# Contribution of individual countires and continenetes to worlwide GHG emissions

What is the contribution of individual countries and continents to the worldwide GHG emissions?

# References  

EDGAR (Emissions Database for Global Atmospheric Research) Community GHG Database (a collaboration between the European Commission, Joint Research Centre (JRC), the International Energy Agency (IEA), and comprising IEA-EDGAR CO2, EDGAR CH4, EDGAR N2O, EDGAR F-GASES version EDGAR_2024_GHG (2024) European Commission.

European Commission, Joint Research Centre, Crippa, M., Guizzardi, D., Pagani, F., Banja, M., Muntean, M., Schaaf, E., Monforti-Ferrario, F., Becker, W.E., Quadrelli, R., Risquez Martin, A., Taghavi-Moharamli, P., Köykkä, J., Grassi, G., Rossi, S., Melo, J., Oom, D., Branco, A., San-Miguel, J., Manca, G., Pisoni, E., Vignati, E. and Pekar, F., GHG emissions of all world countries, Publications Office of the European Union, Luxembourg, 2024, https://data.europa.eu/doi/10.2760/4002897, JRC138862.

IEA-EDGAR CO2 (v3), a component of the EDGAR (Emissions Database for Global Atmospheric Research) Community GHG database version EDGAR_2024_GHG (2024) including or based on data from IEA (2023) Greenhouse Gas Emissions from Energy, www.iea.org/statistics, as modified by the Joint Research Centre.

Source data: https://edgar.jrc.ec.europa.eu/dataset_ghg2024

EDGAR_2024_GHG website: https://edgar.jrc.ec.europa.eu/dataset_ghg2024 


